name: releases

on:
  push:
    branches:
      - dev
  pull_request:
    branches:
      - dev

jobs:
  setup_ubuntu_x86_64:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python (x64)
        uses: actions/setup-python@v5
        with:
          python-version: 3.x
          architecture: "x64"

      - name: Install Hatch
        run: pip install hatch

      - name: Create Hatch virtual environment for x86_64-linux
        run: hatch env create x86_64-unknown-linux-gnu

      - name: Build Release
        run: hatch run py_project_dev_tools make_exe_release_ci_cd --os_arch_line "x86_64-unknown-linux-gnu"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: unreal_auto_mod_x86_64-unknown-linux-gnu
          path: dist/unreal_auto_mod_x86_64-unknown-linux-gnu.zip

  setup_ubuntu_aarch64:
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python (arm64)
        uses: actions/setup-python@v5
        with:
          python-version: 3.x
          architecture: "arm64"

      - name: Install Hatch
        run: pip install hatch

      - name: Create Hatch virtual environment for aarch64-linux
        run: hatch env create aarch64-unknown-linux-gnu

      - name: Build Release
        run: hatch run py_project_dev_tools make_exe_release_ci_cd --os_arch_line "aarch64-unknown-linux-gnu"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: unreal_auto_mod_aarch64-unknown-linux-gnu
          path: dist/unreal_auto_mod_aarch64-unknown-linux-gnu.zip

  setup_windows_x86_64:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python (x64)
        uses: actions/setup-python@v5
        with:
          python-version: 3.x
          architecture: "x64"

      - name: Install Hatch
        run: pip install hatch

      - name: Create Hatch virtual environment for x86_64-windows
        run: hatch env create x86_64-pc-windows-msvc

      - name: Build Release
        run: hatch run py_project_dev_tools make_exe_release_ci_cd --os_arch_line "x86_64-pc-windows-msvc"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: unreal_auto_mod_x86_64-pc-windows-msvc
          path: dist/unreal_auto_mod_x86_64-pc-windows-msvc.zip

  setup_windows_i686:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python (x86)
        uses: actions/setup-python@v5
        with:
          python-version: 3.x
          architecture: "x86"

      - name: Install Hatch
        run: pip install hatch

      - name: Create Hatch virtual environment for i686-windows
        run: hatch env create i686-pc-windows-msvc

      - name: Build Release
        run: hatch run py_project_dev_tools make_exe_release_ci_cd --os_arch_line "i686-pc-windows-msvc"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: unreal_auto_mod_i686-pc-windows-msvc
          path: dist/unreal_auto_mod_i686-pc-windows-msvc.zip

  bump_version_then_setup_wheels_and_source_distributions:
    runs-on: ubuntu-latest
    needs: [setup_ubuntu_x86_64, setup_ubuntu_aarch64, setup_windows_x86_64, setup_windows_i686]
    steps:
      - name: Check out
        uses: actions/checkout@v4
        with:
          token: "${{ secrets.PERSONAL_ACCESS_TOKEN }}"
          fetch-depth: 0

      - name: Create bump and changelog
        uses: commitizen-tools/commitizen-action@master
        with:
          github_token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          changelog_increment_filename: body.md

      - name: Setup Python (x64)
        uses: actions/setup-python@v5
        with:
          python-version: 3.x
          architecture: "x64"

      - name: Install Hatch
        run: pip install hatch

      - name: Build Wheels and Source Distributions
        run: hatch build

      # - name: Twine check
      #   run: hatch run uvx twine check dist/*

      - name: Publish Wheels and Source Distributions
        run: hatch publish --repo "test" --user "__token__" --auth "${{ secrets.PYPI_PASSWORD }}"

      # - name: Publish Wheels and Source Distributions
      #   run: hatch run uvx twine upload --repository-url https://test.pypi.org/legacy/ dist/* --user "__token__" --password "${{ secrets.PYPI_PASSWORD }}" --verbose

      - name: Download ubuntu_x86_64_artifact
        uses: actions/download-artifact@v4
        with:
          name: unreal_auto_mod_x86_64-unknown-linux-gnu
          path: ./dist

      - name: Download ubuntu_aarch64_artifact
        uses: actions/download-artifact@v4
        with:
          name: unreal_auto_mod_aarch64-unknown-linux-gnu
          path: ./dist

      - name: Download windows_x86_64_artifact
        uses: actions/download-artifact@v4
        with:
          name: unreal_auto_mod_x86_64-pc-windows-msvc
          path: ./dist

      - name: Download windows_i686_artifact
        uses: actions/download-artifact@v4
        with:
          name: unreal_auto_mod_i686-pc-windows-msvc
          path: ./dist

      - name: List files in dist
        run: ls -R dist